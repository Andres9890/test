name: Upload File to Internet Archive

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'Direct Download URL'
        required: true
        type: string
      ia_identifier:
        description: 'Target IA Identifier'
        required: true
        type: string
      rename_to:
        description: 'Rename file to (Optional - leave blank to keep original name)'
        required: false
        type: string

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          
      - name: Install dependencies
        run: pip install internetarchive

      - name: Configure IA CLI
        env:
          IA_EMAIL: ${{ secrets.A_IA_EMAIL }}
          IA_PASSWORD: ${{ secrets.A_IA_PASSWORD }}
        run: |
          echo "Logging into Internet Archive..."
          # Ensure directory exists
          mkdir -p "$HOME/.config/internetarchive"
          
          # Pipe email and password into ia configure
          printf "%s\n%s\n" "$IA_EMAIL" "$IA_PASSWORD" | ia configure

      - name: Download File
        run: |
          mkdir staging
          cd staging
          
          if [ -n "${{ inputs.rename_to }}" ]; then
            echo "Custom name provided. Downloading as: ${{ inputs.rename_to }}"
            wget -O "${{ inputs.rename_to }}" "${{ inputs.file_url }}"
          else
            echo "No custom name provided. Using server filename."
            wget --content-disposition "${{ inputs.file_url }}" || wget "${{ inputs.file_url }}"
          fi
          
          echo "Download complete. Files in staging:"
          ls -lh

      - name: Upload to IA Item
        run: |
          cd staging
          echo "Uploading to item: ${{ inputs.ia_identifier }}"
          
          # Upload everything in staging to the specified item
          ia upload "${{ inputs.ia_identifier }}" . --retries 5
