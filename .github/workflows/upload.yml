name: Upload File to Internet Archive

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'Direct Download URL'
        required: true
        type: string
      ia_identifier:
        description: 'Target IA Identifier'
        required: true
        type: string
      rename_to:
        description: 'Rename file to'
        required: false
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python and Install IA CLI
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: pip install internetarchive

      - name: Download File
        run: |
          mkdir staging
          cd staging
          
          # Check if the user provided a custom filename
          if [ -n "${{ inputs.rename_to }}" ]; then
            echo "Custom name provided. Downloading as: ${{ inputs.rename_to }}"
            wget -O "${{ inputs.rename_to }}" "${{ inputs.file_url }}"
          else
            echo "No custom name provided. Using server filename."
            # --content-disposition gets the filename from the server headers
            wget --content-disposition "${{ inputs.file_url }}" || wget "${{ inputs.file_url }}"
          fi
          
          echo "Download complete. Files in staging:"
          ls -lh

      - name: Upload to IA Item
        env:
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
        run: |
          cd staging
          echo "Uploading to item: ${{ inputs.ia_identifier }}"
          
          # Upload contents of staging directory to the IA item
          ia upload "${{ inputs.ia_identifier }}" . --retries 5
