name: Upload File to Internet Archive

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'Direct Download URL(s) - Comma separated'
        required: true
        type: string
      ia_identifier:
        description: 'Target IA Identifier'
        required: true
        type: string
      rename_to:
        description: 'Rename file(s) to (Optional, comma separated, order matches URLs)'
        required: false
        type: string

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Cache pip and IA Config
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.config/internetarchive
          key: ${{ runner.os }}-upload-cache-${{ hashFiles('.github/workflows/upload.yml') }}
          restore-keys: |
            ${{ runner.os }}-upload-cache-

      - name: Install dependencies
        run: pip install internetarchive

      - name: Configure IA CLI
        env:
          IA_EMAIL: ${{ secrets.A_IA_EMAIL }}
          IA_PASSWORD: ${{ secrets.A_IA_PASSWORD }}
        run: |
          if [ -f "$HOME/.config/internetarchive/ia.ini" ]; then
            echo "IA Configuration restored from cache."
          else
            echo "No cached configuration found. Logging into Internet Archive..."
            mkdir -p "$HOME/.config/internetarchive"
            printf "%s\n%s\n" "$IA_EMAIL" "$IA_PASSWORD" | ia configure
          fi

      - name: Download Files
        shell: bash
        run: |
          mkdir staging
          cd staging
          
          IFS=',' read -ra URLS <<< "${{ inputs.file_url }}"
          IFS=',' read -ra RENAMES <<< "${{ inputs.rename_to }}"
          
          for i in "${!URLS[@]}"; do
            url=$(echo "${URLS[$i]}" | xargs)
            name=$(echo "${RENAMES[$i]}" | xargs)
            
            echo "----------------------------------------"
            echo "Processing URL $((i+1)): $url"
            
            if [ -n "$name" ]; then
              echo "Custom name provided: $name"
              wget -O "$name" "$url"
            else
              echo "No custom name provided. Using server filename."
              wget --content-disposition "$url" || wget "$url"
            fi
          done
          
          echo "----------------------------------------"
          echo "Download complete. Files in staging:"
          ls -lh

      - name: Upload to IA Item
        run: |
          cd staging
          echo "Uploading to item: ${{ inputs.ia_identifier }}"
          ia upload "${{ inputs.ia_identifier }}" . --retries 5

      - name: Upload Artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: downloaded-files
          path: staging/
          retention-days: 90
